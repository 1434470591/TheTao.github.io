\documentclass{article}

\usepackage{amsmath, amssymb}
\usepackage{tikz}
\usetikzlibrary{positioning, calc}
\documentclass[tikz, border=5mm]{standalone}
\usepackage{tikz}
\usepackage{amsmath} % For equation-like text
\usetikzlibrary{shapes,arrows,positioning,fit,decorations.pathreplacing}

\begin{document}

\tikzset{
    % Node styles
    input/.style={rectangle, rounded corners, fill=blue!10, draw=blue!70!black, very thick, text width=5cm, align=center, minimum height=1cm, font=\small\bfseries},
    backbone/.style={rectangle, rounded corners, fill=orange!10, draw=orange!70!black, very thick, text width=4.5cm, align=center, minimum height=1cm, font=\small\bfseries},
    prompt/.style={rectangle, rounded corners, fill=green!10, draw=green!70!black, very thick, text width=4.5cm, align=center, minimum height=1cm, font=\small\bfseries},
    fusion/.style={rectangle, rounded corners, fill=red!10, draw=red!70!black, very thick, text width=4cm, align=center, minimum height=1cm, font=\small\bfseries},
    output/.style={rectangle, rounded corners, fill=purple!10, draw=purple!70!black, very thick, text width=5cm, align=center, minimum height=1cm, font=\small\bfseries},
    operation/.style={rectangle, dashed, fill=gray!5, draw=gray!70, thick, text width=4.5cm, align=center, minimum height=1cm, font=\small},
    note/.style={rectangle, rounded corners, fill=gray!5, draw=gray!70, dashed, thick, text width=4.5cm, align=center, minimum height=1cm, font=\tiny, text badly centered},
    % Arrow styles
    main_arrow/.style={-latex, thick, draw=orange!70!black},
    prompt_arrow/.style={-latex, thick, draw=green!70!black},
    fusion_arrow/.style={-latex, thick, draw=red!70!black},
    data_flow/.style={-latex, thin, draw=gray!70},
    dashed_data_flow/.style={-latex, thin, draw=gray!70, dashed},
    note_line/.style={-latex, thin, draw=gray!70, dashed},
}

\begin{tikzpicture}
    % --- Main Branch Nodes ---
    \node (Input_CSI) [input] {\\textbf{历史 CSI 数据 (Historical Input)}\\Dim: [B, T\_hist, Tx, Rx, Sub, 2]};
    \node (Reshape_Op) [operation, below=1.2cm of Input_CSI] {DATA RESHAPING \& PATCHIFY\\将 Tx, Rx, Sub 折叠为'图像'空间维度\\Dim: [B, T\_hist, Patches, D\_model]};
    \node (ViT_Block_1) [backbone, below=1.5cm of Reshape_Op] {ViT Block N-1\\Self-Attention \& FFN};
    \node (ViT_Block_2) [backbone, below=1.5cm of ViT_Block_1] {ViT Block N\\Self-Attention \& FFN};
    \node (Decoder) [backbone, below=1.5cm of ViT_Block_2] {CSI Prediction Decoder\\Project back to original dimensions};
    \node (Output_CSI) [output, below=1.2cm of Decoder] {\\textbf{未来 CSI 预测 (Predicted Output)}\\Dim: [B, T\_pred, Tx, Rx, Sub, 2]};

    % --- Prompt Branch Nodes ---
    \node (Coherence_Calc) [prompt, right=4cm of Reshape_Op] {\\textbf{Physics Calculation Module}\\基于 Idea 3: IQ Complex Similarity Matrix / Doppler Estimation};
    \node (Prompt_Gen) [prompt, below=1.5cm of Coherence_Calc] {\\textbf{Prompt Generation}\\Map Similarity to Soft Prompt Vectors / Tokens\\e.g., 'Fast Fading State'};
    \node (Prompt_Encoder) [prompt, below=1.5cm of Prompt_Gen] {Coherence Prompt Encoder\\Lightweight Transformer / MLP};
    \node (Prompt_Feats) [prompt, below=1.2cm of Prompt_Encoder] {\\textbf{Coherence Prompt Features}\\(Key \& Value for Cross-Attn)};

    % --- Fusion Nodes ---
    \node (CrossAttn1) [fusion, right=1.5cm of ViT_Block_1] {\\textbf{Cross-Attention Fusion Layer}\\Query: CSI Features\\Key/Value: Coherence Prompt};
    \node (CrossAttn2) [fusion, right=1.5cm of ViT_Block_2] {\\textbf{Cross-Attention Fusion Layer}\\Query: CSI Features\\Key/Value: Coherence Prompt};

    % --- Main Branch Arrows ---
    \draw [main_arrow] (Input_CSI) -- (Reshape_Op);
    \draw [main_arrow] (Reshape_Op) -- (ViT_Block_1);
    \draw [main_arrow] (ViT_Block_1) -- (ViT_Block_2);
    \draw [main_arrow] (ViT_Block_2) -- (Decoder);
    \draw [main_arrow] (Decoder) -- (Output_CSI);

    % --- Prompt Branch Arrows ---
    \draw [prompt_arrow] (Input_CSI.east) -| (Coherence_Calc); % Input_CSI -> Coherence_Calc
    \draw [prompt_arrow] (Coherence_Calc) -- (Prompt_Gen);
    \draw [prompt_arrow] (Prompt_Gen) -- (Prompt_Encoder);
    \draw [prompt_arrow] (Prompt_Encoder) -- (Prompt_Feats);

    % --- Fusion Arrows ---
    % ViT_Block_1 -> CrossAttn1 -> ViT_Block_2
    \draw [fusion_arrow] (ViT_Block_1.east) -- node[above=0.1cm, sloped, font=\tiny]{CSI Features (Q)} (CrossAttn1.west);
    \draw [fusion_arrow] (Prompt_Feats.north) -| node[above=0.1cm, font=\tiny]{Prompt K,V} (CrossAttn1.east);
    \draw [fusion_arrow] (CrossAttn1.south) |- (ViT_Block_2.east); % Connecting back to main branch implicitly (e.g. residual connection)
    
    % ViT_Block_2 -> CrossAttn2 -> Decoder
    \draw [fusion_arrow] (ViT_Block_2.east) -- node[above=0.1cm, sloped, font=\tiny]{CSI Features (Q)} (CrossAttn2.west);
    \draw [fusion_arrow] (Prompt_Feats.north) -| node[above=0.1cm, font=\tiny]{Prompt K,V} (CrossAttn2.east);
    \draw [fusion_arrow] (CrossAttn2.south) |- (Decoder.east); % Connecting back to main branch implicitly

    % --- Subgraph Boundaries ---
    \node[fit=(Input_CSI) (Reshape_Op) (ViT_Block_1) (ViT_Block_2) (Decoder) (Output_CSI), draw=gray, thick, rounded corners, inner sep=0.5cm, label={[font=\small\bfseries]above left: Main Task: High-Dim CSI Forecasting}] (main_subgraph) {};
    \node[fit=(Coherence_Calc) (Prompt_Gen) (Prompt_Encoder) (Prompt_Feats), draw=gray, thick, rounded corners, inner sep=0.5cm, label={[font=\small\bfseries]above left: Innovation: Physics-Aware Coherence Prompting}] (prompt_subgraph) {};

    % --- Notes ---
    \node (note_high_dim) [note, left=0.8cm of Reshape_Op, text width=4cm] {\\textbf{高维处理关键:}\\将Tx,Rx,Sub视为单一'图像'的\\空间/频域像素进行Patch化处理};
    \draw [note_line] (note_high_dim.east) -- (Reshape_Op.west);

    \node (note_innovation) [note, left=0.8cm of CrossAttn1, text width=4cm] {\\textbf{核心创新 (The VLM Concept):}\\将物理相干性转化为语义'提示(Prompt)',\\通过交叉注意力指导模型关注\\符合当前物理状态的特征。};
    \draw [note_line] (note_innovation.east) -- (CrossAttn1.west);

\end{tikzpicture}
\end{document}